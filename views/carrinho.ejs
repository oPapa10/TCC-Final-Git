<!-- filepath: views/carrinho.ejs -->
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrinho de Compras</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/stylesheets/menu-superior.css">
    <link rel="stylesheet" href="/stylesheets/carrinho.css">
    <link rel="stylesheet" href="/stylesheets/footer.css"/>
    <link rel="stylesheet" href="/stylesheets/theme.css">
    
</head>
<body>
    <%- include('partials/navbar', { usuario: usuario }) %>

    <!-- Conteúdo da Página -->
    <div class="container mt-5 pt-5">
        <h1 class="mb-4">Carrinho de Compras</h1>
        <% if (typeof mensagemCompra !== 'undefined' && mensagemCompra) { %>
            <div class="alert alert-success text-center mt-4">
                <%= mensagemCompra %>
            </div>
        <% } %>
        <div class="cart-header">
            <span class="header-product">Produto</span>
            <span class="header-unit">Preço Unitário</span>
            <span class="header-quantity">Quantidade</span>
            <span class="header-total">Total</span>
            <span class="header-action">Ação</span>
        </div>
        <div id="cart-container">
            <% if (!carrinho || carrinho.length === 0) { %>
                <div class="cart-empty text-center my-5">
                    <img src="https://cdn-icons-png.flaticon.com/512/2038/2038854.png" alt="Carrinho vazio" style="width:80px;">
                    <p class="mt-3">Seu carrinho está vazio</p>
                    <a href="/" class="cart-continue-btn btn btn-primary mt-2">Voltar às compras</a>
                </div>
            <% } else { %>
                <% let total = 0; %>
                <% carrinho.forEach(function(item) { if (!item.oculto) { total += item.preco * item.quantidade; } }) %>
                <% carrinho.forEach(function(item) { %>
                    <div class="cart-item" style="<%= item.oculto ? 'opacity:0.5; pointer-events:none;' : '' %>">
                        <div class="item-details">
                            <img src="<%= item.imagem %>" class="item-image me-3" alt="<%= item.nome %>">
                            <div class="item-info">
                                <div class="item-name"><%= item.nome %></div>
                                <% if (item.semEstoque) { %>
                                    <div class="text-danger fw-bold mt-2">Produto indisponível no momento</div>
                                <% } %>
                                <% if (item.mudancaPromocao) { %>
                                    <div class="alert alert-warning mt-2 mudanca-promocao-msg" style="padding: 6px 12px;">
                                        O valor deste produto foi alterado recentemente.
                                    </div>
                                <% } %>
                            </div>
                        </div>
                        <div class="item-unit">
                            <% if (item.valorPromocional) { %>
                                <span class="text-danger fw-bold">
                                    R$ <%= item.valorPromocional.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %>
                                </span>
                                <span class="text-muted text-decoration-line-through ms-2">
                                    R$ <%= item.valorOriginal.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %>
                                </span>
                            <% } else { %>
                                <span>
                                    R$ <%= item.valorOriginal.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %>
                                </span>
                            <% } %>
                        </div>
                        <div class="item-quantity d-flex align-items-center justify-content-center">
                            <form action="/carrinho/alterar" method="POST" style="display:inline;" class="form-alterar">
                                <input type="hidden" name="produtoId" value="<%= item.produtoId %>">
                                <input type="hidden" name="acao" value="diminuir">
                                <button type="submit" class="btn btn-outline-secondary btn-sm" <%= item.quantidade <= 1 ? 'disabled' : '' %>>-</button>
                            </form>
                            <span class="mx-2"><%= item.quantidade %></span>
                            <form action="/carrinho/alterar" method="POST" style="display:inline;" class="form-alterar">
                                <input type="hidden" name="produtoId" value="<%= item.produtoId %>">
                                <input type="hidden" name="acao" value="aumentar">
                                <button type="submit" class="btn btn-outline-secondary btn-sm" <%= item.quantidade >= (item.estoque || 99) ? 'disabled' : '' %>>+</button>
                            </form>
                        </div>
                        <div class="item-total">
                            R$ <%= Number(item.preco * item.quantidade).toLocaleString('pt-BR', {minimumFractionDigits: 2}) %>
                        </div>
                        <div class="item-actions d-flex flex-column align-items-center gap-2" style="<%= item.oculto ? 'pointer-events:auto;' : '' %>">
                            <form action="/carrinho/remover" method="POST" class="mb-0">
                                <input type="hidden" name="produtoId" value="<%= item.produtoId %>">
                                <button type="submit" class="remove-btn btn btn-danger btn-sm">Remover</button>
                            </form>
                            <% if (!item.oculto && !item.semEstoque) { %>
                                <form action="/carrinho/ocultar" method="POST" class="mb-0 form-ocultar">
                                    <input type="hidden" name="produtoId" value="<%= item.produtoId %>">
                                    <button type="submit" class="btn btn-outline-secondary btn-sm">Ocultar</button>
                                </form>
                            <% } else if (item.oculto && !item.semEstoque) { %>
                                <form action="/carrinho/mostrar" method="POST" class="mb-0 form-mostrar">
                                    <input type="hidden" name="produtoId" value="<%= item.produtoId %>">
                                    <button type="submit" class="btn btn-outline-primary btn-sm">Reativar</button>
                                </form>
                            <% } %>
                            <!-- Se estiver sem estoque, não mostra botão de reativar nem de ocultar -->
                        </div>
                    </div>
                <% }) %>
                <div class="cart-summary mt-4">
                    <div class="cart-total d-flex justify-content-between align-items-center">
                        <span>Subtotal:</span>
                        <span id="total">R$ <%= Number(total).toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></span>
                    </div>
                    <div class="cart-actions d-flex justify-content-between mt-3">
                        <a class="cart-continue-btn btn btn-outline-primary" href="/">Continuar Comprando</a>
                        <form action="/carrinho/pedido/finalizar" method="POST" class="mb-0" id="formFinalizarCompra">
                            <button type="submit" class="cart-checkout-btn btn btn-success">Finalizar Compra</button>
                        </form>
                    </div>
                </div>
            <% } %>
        </div>
    </div>

    <%- include('partials/footer') %>

    <script>
(function() {
  var theme = localStorage.getItem('theme');
  if (theme === 'escuro') {
    document.body.classList.add('dark-theme');
  } else {
    document.body.classList.remove('dark-theme');
  }
})();
</script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
function ativarFormOcultarMostrar() {
    document.querySelectorAll('.form-ocultar, .form-mostrar').forEach(form => {
        form.onsubmit = null;
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const produtoId = this.querySelector('input[name="produtoId"]').value;
            fetch(this.action, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'produtoId=' + encodeURIComponent(produtoId)
            }).then(response => response.json())
            .then(() => {
                fetch('/carrinho')
                    .then(res => res.text())
                    .then(html => {
                        const temp = document.createElement('div');
                        temp.innerHTML = html;
                        const novoContainer = temp.querySelector('#cart-container');
                        if (novoContainer) {
                            document.getElementById('cart-container').innerHTML = novoContainer.innerHTML;
                            ativarFormOcultarMostrar();
                            ativarFormAlterar(); // Reativa eventos das setinhas!
                        }
                    });
            });
        });
    });
}

function ativarFormAlterar() {
    document.querySelectorAll('.form-alterar').forEach(form => {
        form.onsubmit = null;
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const produtoId = this.querySelector('input[name="produtoId"]').value;
            const acao = this.querySelector('input[name="acao"]').value;
            fetch(this.action, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'produtoId=' + encodeURIComponent(produtoId) + '&acao=' + encodeURIComponent(acao)
            }).then(() => {
                fetch('/carrinho')
                    .then(res => res.text())
                    .then(html => {
                        const temp = document.createElement('div');
                        temp.innerHTML = html;
                        const novoContainer = temp.querySelector('#cart-container');
                        if (novoContainer) {
                            document.getElementById('cart-container').innerHTML = novoContainer.innerHTML;
                            ativarFormOcultarMostrar();
                            ativarFormAlterar();
                        }
                    });
            });
        });
    });
}

ativarFormOcultarMostrar();
ativarFormAlterar();

document.getElementById('formFinalizarCompra').addEventListener('submit', function(e) {
    setTimeout(function() {
        alert('Compra efetuada com sucesso!');
    }, 100); // Pequeno delay para garantir que o submit ocorra
});

window.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        document.querySelectorAll('.mudanca-promocao-msg').forEach(function(el) {
            el.style.display = 'none';
        });
    }, 30000); // 30 segundos
});
</script>

</body>
</html>