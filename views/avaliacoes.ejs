<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhas Avaliações</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/stylesheets/menu-superior.css">
    <link rel="stylesheet" href="/stylesheets/avaliacao.css">
    <link rel="stylesheet" href="/stylesheets/footer.css">
    <link rel="stylesheet" href="/stylesheets/theme.css">
</head>
<body>

<%- include('partials/navbar', { usuario: usuario }) %>

<main class="container mt-5 pt-5">
    <h2 class="text-center mb-4">Minhas Avaliações</h2>
    
    <% if (!produtos || produtos.length === 0) { %>
        <div class="alert alert-warning text-center mt-5">Você ainda não comprou nenhum produto.</div>
    <% } else { %>
        <div class="row">
            <% produtos.forEach(function(produto, index) { 
                let av = avaliacoes.find(a => a.produto_id == produto.ID);
            %>
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <img src="<%= produto.imagem || '/images/product-placeholder.jpg' %>" alt="Produto" class="product-image">
                                <div class="flex-grow-1 ms-3">
                                    <h5 class="product-title"><%= produto.nome %></h5>
                                    <p class="product-category"><%= produto.categoria_nome %></p>
                                </div>
                            </div>
                            
                            <% if (av) { %>
                                <div class="existing-rating">
                                    <strong class="d-block text-center mb-2">Sua avaliação:</strong>
                                    <div class="stars-container text-center mb-2">
                                        <% for(let i=1; i<=5; i++) { %>
                                            <span class="fa fa-star <%= i <= av.estrela ? 'checked' : '' %>"></span>
                                        <% } %>
                                    </div>
                                    <p class="rating-comment text-center"><%= av.descricao %></p>
                                    <div class="text-center">
                                        <form action="/avaliacao/remover" method="POST" style="display:inline;">
                                            <input type="hidden" name="avaliacaoId" value="<%= av.id %>">
                                            <input type="hidden" name="produtoId" value="<%= produto.ID %>">
                                            <button type="submit" class="btn btn-danger btn-sm">Remover Avaliação</button>
                                        </form>
                                    </div>
                                </div>
                            <% } else { %>
                                <form class="form-avaliacao" action="/avaliacao/enviar" method="POST">
                                    <input type="hidden" name="produtoId" value="<%= produto.ID %>">
                                    <input type="hidden" name="origem" value="avaliacoes">
                                    
                                    <div class="rating-section mb-3">
                                        <label class="form-label text-center d-block mb-3">Sua Avaliação:</label>
                                        <div class="rating-container">
                                            <div class="rating-stars" data-produto="<%= produto.ID %>">
                                                <% for(let i=5; i>=1; i--) { %>
                                                    <input type="radio" id="star<%= i %>_<%= produto.ID %>" name="estrela" value="<%= i %>" required>
                                                    <label for="star<%= i %>_<%= produto.ID %>" title="<%= getRatingText(i) %>">
                                                        <i class="fas fa-star"></i>
                                                    </label>
                                                <% } %>
                                            </div>
                                            <div class="rating-text" id="rating-text-<%= produto.ID %>">Selecione uma avaliação</div>
                                        </div>
                                    </div>
                                    
                                    <div class="comment-section mb-3">
                                        <label class="form-label">Comentário:</label>
                                        <textarea name="descricao" class="form-control compact-textarea" rows="2" maxlength="200" placeholder="Escreva um comentário breve (máx. 200 caracteres)" required></textarea>
                                        <div class="form-text text-end"><span id="char-count-<%= produto.ID %>">0</span>/200</div>
                                    </div>
                                    
                                    <div class="text-center">
                                        <button type="submit" class="btn btn-primary">Enviar Avaliação</button>
                                    </div>
                                </form>
                            <% } %>
                        </div>
                    </div>
                </div>
                
                <% if ((index + 1) % 2 === 0) { %>
                    </div><div class="row">
                <% } %>
            <% }) %>
        </div>
    <% } %>
</main>

<%- include('partials/footer') %>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Sistema de avaliação com estrelas
    document.querySelectorAll('.rating-stars').forEach(function(ratingContainer) {
        const produtoId = ratingContainer.getAttribute('data-produto');
        const stars = ratingContainer.querySelectorAll('input[type="radio"]');
        const ratingText = document.getElementById('rating-text-' + produtoId);
        const textarea = document.querySelector(`form input[name="produtoId"][value="${produtoId}"]`).closest('form').querySelector('textarea[name="descricao"]');
        const charCount = document.getElementById('char-count-' + produtoId);

        function getRatingText(rating) {
            const ratings = {
                '1': 'Péssimo - Produto muito ruim',
                '2': 'Ruim - Produto com problemas',
                '3': 'Regular - Produto aceitável',
                '4': 'Bom - Produto satisfatório',
                '5': 'Excelente - Produto perfeito'
            };
            return ratings[rating] || 'Selecione uma avaliação';
        }

        // Adiciona eventos para cada estrela
        stars.forEach(function(star) {
            star.addEventListener('change', function() {
                const selectedValue = this.value;
                
                // Atualiza todas as estrelas
                stars.forEach(function(s, index) {
                    const starIndex = 5 - index;
                    const label = s.nextElementSibling;
                    if (starIndex <= selectedValue) {
                        label.classList.add('selected');
                        label.classList.remove('unselected');
                    } else {
                        label.classList.remove('selected');
                        label.classList.add('unselected');
                    }
                });
                
                // Atualiza texto e aplica efeito de explosão
                ratingText.textContent = getRatingText(selectedValue);
                ratingText.classList.add('rating-selected');
                
                // Efeito de explosão na estrela selecionada
                const label = this.nextElementSibling;
                label.classList.add('star-explosion');
                setTimeout(() => {
                    label.classList.remove('star-explosion');
                }, 600);
            });
            
            star.addEventListener('mouseover', function() {
                const hoverValue = this.value;
                ratingText.textContent = getRatingText(hoverValue);
                
                // Highlight estrelas no hover
                stars.forEach(function(s, index) {
                    const starIndex = 5 - index;
                    const label = s.nextElementSibling;
                    if (starIndex <= hoverValue) {
                        label.style.color = '#ffc107';
                    } else {
                        label.style.color = '#dee2e6';
                    }
                });
            });
        });

        // Reseta cores quando o mouse sai
        ratingContainer.addEventListener('mouseleave', function() {
            const checkedStar = ratingContainer.querySelector('input:checked');
            if (checkedStar) {
                const selectedValue = checkedStar.value;
                ratingText.textContent = getRatingText(selectedValue);
                ratingText.classList.add('rating-selected');
                
                // Mantém as estrelas selecionadas amarelas
                stars.forEach(function(s, index) {
                    const starIndex = 5 - index;
                    const label = s.nextElementSibling;
                    if (starIndex <= selectedValue) {
                        label.style.color = '#ffc107';
                    } else {
                        label.style.color = '#dee2e6';
                    }
                });
            } else {
                ratingText.textContent = 'Selecione uma avaliação';
                ratingText.classList.remove('rating-selected');
                
                // Reseta todas as estrelas
                stars.forEach(function(s) {
                    const label = s.nextElementSibling;
                    label.style.color = '#dee2e6';
                });
            }
        });
        
        // Contador de caracteres para o textarea
        if (textarea && charCount) {
            textarea.addEventListener('input', function() {
                charCount.textContent = this.value.length;
                
                // Altera cor quando atingir o limite
                if (this.value.length > 180) {
                    charCount.style.color = '#dc3545';
                } else if (this.value.length > 150) {
                    charCount.style.color = '#ffc107';
                } else {
                    charCount.style.color = '#6c757d';
                }
            });
        }
    });
});
</script>

<%
function getRatingText(rating) {
    const ratings = {
        1: 'Péssimo - Produto muito ruim',
        2: 'Ruim - Produto com problemas',
        3: 'Regular - Produto aceitável',
        4: 'Bom - Produto satisfatório',
        5: 'Excelente - Produto perfeito'
    };
    return ratings[rating] || '';
}
%>

</body>
</html>