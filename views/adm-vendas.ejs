<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle de Vendas — ADM</title>
  <link rel="stylesheet" href="/stylesheets/adm.css">
  <link rel="stylesheet" href="/stylesheets/index.css">
  <link rel="stylesheet" href="/stylesheets/adm-vendas.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

  <main class="container-lg mt-4 mb-5">
    <!-- Cabeçalho -->
    <div class="header-section">
      <a href="/adm" class="btn-voltar">
        <i class="fas fa-arrow-left"></i> Voltar ao ADM
      </a>
      <h1 class="header-title">
        <i class="fas fa-chart-line me-2"></i>Controle de Vendas
      </h1>
    </div>

    <!-- Cards de Métricas -->
    <div class="row g-4 mb-4">
      <div class="col-md-3">
        <div class="metric-card">
          <div class="metric-icon total-vendas">
            <i class="fas fa-shopping-bag"></i>
          </div>
          <div class="metric-info">
            <h3><%= totalVendas || 0 %></h3>
            <p>Total de Vendas</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="metric-card">
          <div class="metric-icon pendentes">
            <i class="fas fa-clock"></i>
          </div>
          <div class="metric-info">
            <h3><%= vendasPendentes || 0 %></h3>
            <p>Pendentes</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="metric-card">
          <div class="metric-icon caminho">
            <i class="fas fa-cart-shopping moving-cart" aria-hidden="true"></i>
          </div>
          <div class="metric-info">
            <h3><%= vendasCaminho || 0 %></h3>
            <p>A caminho</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="metric-card">
          <div class="metric-icon entregues">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="metric-info">
            <h3><%= vendasEntregues || 0 %></h3>
            <p>Entregues</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="card-promocao filters-card">
      <h3 class="filters-title mb-3">
        <i class="fas fa-filter me-2"></i>Filtros de Vendas
      </h3>
      <form class="row g-3" method="GET" action="/adm/vendas">
        <div class="col-md-2">
          <label class="form-label">Ano</label>
          <select name="year" class="form-select">
            <option value="">Todos</option>
            <% years.forEach(function(y){ %>
              <option value="<%= y %>" <%= (filters.year==y)?'selected':'' %>><%= y %></option>
            <% }) %>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Mês</label>
          <select name="month" class="form-select">
            <option value="">Todos</option>
            <% for(let m=1;m<=12;m++){ %>
              <option value="<%= m %>" <%= (filters.month==m)?'selected':'' %>><%= m %></option>
            <% } %>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Dia</label>
          <select name="day" class="form-select">
            <option value="">Todos</option>
            <% for(let d=1;d<=31;d++){ %>
              <option value="<%= d %>" <%= (filters.day==d)?'selected':'' %>><%= d %></option>
            <% } %>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label"><i class="fas fa-search me-1"></i>Busca por produto / ID</label>
          <input name="search" type="text" class="form-control" value="<%= filters.search || '' %>" placeholder="Nome do produto ou ID">
        </div>

        <div class="col-md-1">
          <label class="form-label"><i class="fas fa-star me-1"></i>Avaliação</label>
          <select name="rating" class="form-select">
            <option value="">-</option>
            <% for(let r=1;r<=5;r++){ %>
              <option value="<%= r %>" <%= (filters.rating==r)?'selected':'' %>><%= r %></option>
            <% } %>
          </select>
        </div>

        <div class="col-md-2 d-flex gap-2">
          <div class="flex-fill">
            <label class="form-label">Preço min</label>
            <input type="number" step="0.01" name="priceMin" class="form-control" value="<%= filters.priceMin || '' %>" placeholder="R$ 0,00">
          </div>
          <div class="flex-fill">
            <label class="form-label">Preço max</label>
            <input type="number" step="0.01" name="priceMax" class="form-control" value="<%= filters.priceMax || '' %>" placeholder="R$ 0,00">
          </div>
        </div>

        <div class="col-12 text-end mt-2">
          <button class="btn btn-primary">
            <i class="fas fa-filter me-2"></i>Aplicar filtros
          </button>
          <a href="/adm/vendas" class="btn btn-outline-secondary">
            <i class="fas fa-eraser me-2"></i>Limpar
          </a>
        </div>
      </form>
    </div>

    <!-- Navegação por status -->
    <div class="mb-4">
      <div class="status-nav">
        <a class="status-nav-item <%= (!filters.status || filters.status==='entregue')?'active':'' %>" href="/adm/vendas?status=entregue">
          <i class="fas fa-check-circle me-2"></i>Vendas realizadas
        </a>
        <a class="status-nav-item <%= (filters.status==='a_caminho') ? 'active' : '' %>" href="/adm/vendas?status=a_caminho">
          <i class="fas fa-shipping-fast me-2"></i>Vendas em trajeto
        </a>
        <a class="status-nav-item <%= (!filters.status || filters.status==='pendente' || filters.status==='pronto') ? 'active' : '' %>" href="/adm/vendas?status=pendente">
          <i class="fas fa-clock me-2"></i>Vendas pendentes
        </a>
      </div>
    </div>

    <!-- Tabela de Vendas -->
    <div class="card-promocao">
      <div class="table-responsive">
        <table class="table table-hover vendas-table mb-0">
          <thead>
            <tr>
              <th>Foto</th>
              <th>ID</th>
              <th>Data / Hora</th>
              <th>Produto</th>
              <th>Cliente</th>
              <th class="text-center">Valor</th>
              <th>Avaliação</th>
              <th>Ações / Status</th>
            </tr>
          </thead>
          <tbody>
            <% if (vendas && vendas.length) { %>
              <% vendas.forEach(function(v){ %>
                <tr class="venda-row">
                  <td style="width:80px">
                    <% if (v.produto_imagem) { %>
                      <img src="<%= v.produto_imagem %>" alt="Foto" class="prod-thumb rounded">
                    <% } else { %>
                      <div class="prod-thumb placeholder rounded d-flex align-items-center justify-content-center text-muted">
                        <i class="fas fa-image"></i>
                      </div>
                    <% } %>
                  </td>
                  <td><strong>#<%= v.ID %></strong></td>
                  <td><%= new Date(v.hora_venda).toLocaleString('pt-BR') %></td>
                  <td>
                    <strong class="produto-nome"><%= v.produto_nome %></strong>
                    <div class="small-muted">ID <%= v.produto_id %></div>
                  </td>
                  <td>
                    <strong><%= v.cliente_nome %></strong>
                    <div class="small-muted"><%= v.cliente_email %></div>
                  </td>
                  <td class="text-center align-middle">
                    <div class="valor-mais">
                      <% 
                        const valorVenda = Number(v.valor_venda || 0);
                        const valorProduto = Number(v.produto_valor || 0);
                      %>
                      <% if (valorProduto && valorVenda < valorProduto) { %>
                        <div class="small-muted text-decoration-line-through">R$ <%= valorProduto.toLocaleString('pt-BR', {minimumFractionDigits:2}) %></div>
                        <div class="fw-bold">R$ <%= valorVenda.toLocaleString('pt-BR', {minimumFractionDigits:2}) %></div>
                      <% } else { %>
                        R$ <%= valorVenda.toLocaleString('pt-BR', {minimumFractionDigits:2}) %>
                      <% } %>
                    </div>
                  </td>
                  <td class="align-middle text-center">
                    <% if (v.produto_qtd_avaliacoes && v.produto_qtd_avaliacoes > 0) { %>
                      <div class="rating-stars">
                        <% for(let i=1; i<=5; i++) { %>
                          <i class="fas fa-star <%= i <= Math.round(v.produto_media) ? 'text-warning' : 'text-muted' %>"></i>
                        <% } %>
                      </div>
                      <div class="text-muted small mt-1"><%= v.produto_qtd_avaliacoes %> avaliação<%= v.produto_qtd_avaliacoes>1 ? 's' : '' %></div>
                    <% } else { %>
                      <span class="text-muted">-</span>
                    <% } %>
                  </td>
                  <td class="align-middle">
                    <div class="d-flex flex-column gap-2">
                      <!-- status badge -->
                      <div class="status-badge-container">
                        <% if (v.status === 'pendente') { %>
                          <span class="status-badge status-pendente">
                            <i class="fas fa-clock me-1"></i>Pendente
                          </span>
                        <% } else if (v.status === 'pronto') { %>
                          <span class="status-badge status-pronto">
                            <i class="fas fa-box me-1"></i>Pronto
                          </span>
                        <% } else if (v.status === 'a_caminho') { %>
                          <span class="status-badge status-caminho">
                            <i class="fas fa-shipping-fast me-1"></i>A caminho
                          </span>
                        <% } else if (v.status === 'entregue') { %>
                          <span class="status-badge status-entregue">
                            <i class="fas fa-check-circle me-1"></i>Entregue
                          </span>
                        <% } else if (v.status === 'realizada') { %>
                          <span class="status-badge status-entregue">
                            <i class="fas fa-check-circle me-1"></i>Realizada
                          </span>
                        <% } else { %>
                          <span class="status-badge status-desconhecido">
                            <i class="fas fa-question-circle me-1"></i><%= v.status || '—' %>
                          </span>
                        <% } %>
                      </div>

                      <!-- ações conforme status -->
                      <div class="action-buttons">
                        <% if (v.status === 'pendente') { %>
                          <form method="POST" action="/adm/vendas/<%= v.ID %>/pronto" class="d-inline">
                            <button class="btn-action btn-action-ready">
                              <i class="fas fa-box me-1"></i>Pronto para envio
                            </button>
                          </form>
                        <% } else if (v.status === 'pronto') { %>
                          <form method="POST" action="/adm/vendas/<%= v.ID %>/caminho" class="d-inline">
                            <button class="btn-action btn-action-ship">
                              <i class="fas fa-shipping-fast me-1"></i>Enviar
                            </button>
                          </form>
                        <% } %>
                      </div>
                    </div>
                  </td>
                </tr>
              <% }) %>
            <% } else { %>
              <tr>
                <td colspan="8" class="text-center py-5">
                  <i class="fas fa-receipt fa-3x mb-3" style="color: #dee2e6;"></i>
                  <h5 class="text-muted">Nenhuma venda encontrada</h5>
                  <p class="text-muted mb-0">Tente ajustar os filtros para ver mais resultados.</p>
                </td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>