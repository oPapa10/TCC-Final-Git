<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle de Vendas — ADM</title>
  <link rel="stylesheet" href="/stylesheets/adm.css">
  <link rel="stylesheet" href="/stylesheets/index.css">
  <link rel="stylesheet" href="/stylesheets/adm-vendas.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

  <main class="container-lg mt-4 mb-5">
    <!-- Cabeçalho -->
    <div class="header-section">
      <a href="/admCenterMotos" class="btn-voltar">
        <i class="fas fa-arrow-left"></i> Voltar ao ADM
      </a>
      <h1 class="header-title">
        <i class="fas fa-chart-line me-2"></i>Controle de Vendas
      </h1>
    </div>

    <!-- Cards de Métricas -->
    <div class="row g-4 mb-4">
      <div class="col-md-3">
        <div class="metric-card">
          <div class="metric-icon total-vendas">
            <i class="fas fa-shopping-bag"></i>
          </div>
          <div class="metric-info">
            <h3><%= totalVendas || 0 %></h3>
            <p>Total de Vendas</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="metric-card">
          <div class="metric-icon pendentes">
            <i class="fas fa-clock"></i>
          </div>
          <div class="metric-info">
            <h3><%= vendasPendentes || 0 %></h3>
            <p>Pendentes</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="metric-card">
          <div class="metric-icon caminho">
            <i class="fas fa-cart-shopping moving-cart" aria-hidden="true"></i>
          </div>
          <div class="metric-info">
            <h3><%= vendasCaminho || 0 %></h3>
            <p>A caminho</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="metric-card">
          <div class="metric-icon entregues">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="metric-info">
            <h3><%= vendasEntregues || 0 %></h3>
            <p>Entregues</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="card-promocao filters-card">
      <h3 class="filters-title mb-3">
        <i class="fas fa-filter me-2"></i>Filtros de Vendas
      </h3>
      <form class="row g-3" method="GET" action="/admCenterMotos/vendas">
        <!-- substitua os selects únicos de Ano / Mês / Dia por pares "De / Até" -->
        <div class="col-md-4">
          <label class="form-label">Ano (De / Até)</label>
          <div class="d-flex gap-2">
            <select name="yearFrom" class="form-select" aria-label="Ano de">
              <option value="">De</option>
              <% years.forEach(function(y){ %>
                <option value="<%= y %>" <%= (filters.yearFrom==y)?'selected':'' %>><%= y %></option>
              <% }) %>
            </select>
            <select name="yearTo" class="form-select" aria-label="Ano até">
              <option value="">Até (opcional)</option>
              <% years.forEach(function(y){ %>
                <option value="<%= y %>" <%= (filters.yearTo==y)?'selected':'' %>><%= y %></option>
              <% }) %>
            </select>
          </div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Mês (De / Até)</label>
          <div class="d-flex gap-2">
            <select name="monthFrom" class="form-select" aria-label="Mês de">
              <option value="">De</option>
              <% for(let m=1;m<=12;m++){ %>
                <option value="<%= m %>" <%= (filters.monthFrom==m)?'selected':'' %>><%= m %></option>
              <% } %>
            </select>
            <select name="monthTo" class="form-select" aria-label="Mês até">
              <option value="">Até (opcional)</option>
              <% for(let m=1;m<=12;m++){ %>
                <option value="<%= m %>" <%= (filters.monthTo==m)?'selected':'' %>><%= m %></option>
              <% } %>
            </select>
          </div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Dia (De / Até)</label>
          <div class="d-flex gap-2">
            <select name="dayFrom" class="form-select" aria-label="Dia de">
              <option value="">De</option>
              <% for(let d=1;d<=31;d++){ %>
                <option value="<%= d %>" <%= (filters.dayFrom==d)?'selected':'' %>><%= d %></option>
              <% } %>
            </select>
            <select name="dayTo" class="form-select" aria-label="Dia até">
              <option value="">Até (opcional)</option>
              <% for(let d=1;d<=31;d++){ %>
                <option value="<%= d %>" <%= (filters.dayTo==d)?'selected':'' %>><%= d %></option>
              <% } %>
            </select>
          </div>
        </div>

        <div class="col-md-3">
          <label class="form-label"><i class="fas fa-search me-1"></i>Busca por Nome / ID</label>
          <input name="search" type="text" class="form-control" value="<%= filters.search || '' %>" placeholder="Nome do produto ou ID do produto">
        </div>

        <div class="col-md-2 d-flex gap-2">
          <div class="flex-fill">
            <label class="form-label">Preço min</label>
            <input type="number" step="0.01" name="priceMin" class="form-control" value="<%= filters.priceMin || '' %>" placeholder="R$ 0,00">
          </div>
          <div class="flex-fill">
            <label class="form-label">Preço max</label>
            <input type="number" step="0.01" name="priceMax" class="form-control" value="<%= filters.priceMax || '' %>" placeholder="R$ 0,00">
          </div>
        </div>

        <div class="col-12 text-end mt-2">
          <button class="btn btn-primary">
            <i class="fas fa-filter me-2"></i>Aplicar filtros
          </button>
          <a href="/admCenterMotos/vendas" class="btn btn-outline-secondary">
            <i class="fas fa-eraser me-2"></i>Limpar
          </a>
        </div>
      </form>
    </div>

    <!-- Navegação por status -->
    <div class="mb-4">
      <div class="status-nav">
        <a class="status-nav-item <%= (!filters.status || filters.status==='entregue')?'active':'' %>" href="/admCenterMotos/vendas?status=entregue">
          <i class="fas fa-check-circle me-2"></i>Vendas realizadas
        </a>
        <a class="status-nav-item <%= (filters.status==='a_caminho') ? 'active' : '' %>" href="/admCenterMotos/vendas?status=a_caminho">
          <i class="fas fa-shipping-fast me-2"></i>Vendas em trajeto
        </a>
        <a class="status-nav-item <%= (!filters.status || filters.status==='pendente' || filters.status==='pronto') ? 'active' : '' %>" href="/admCenterMotos/vendas?status=pendente">
          <i class="fas fa-clock me-2"></i>Vendas pendentes
        </a>
      </div>
    </div>

    <!-- Tabela de Vendas -->
    <div class="card-promocao">
      <div class="table-responsive">
        <table class="table table-hover vendas-table mb-0">
          <thead>
            <tr>
              <th>Foto</th>
              <th>ID</th>
              <th>Data / Hora</th>
              <th>Produto</th>
              <th>Cliente</th>
              <th class="text-center">Valor</th>
              <th>Avaliação</th>
              <th>Ações / Status</th>
            </tr>
          </thead>
          <tbody>
            <% if (vendas && vendas.length) { %>
              <% vendas.forEach(function(v){ %>
                <tr class="venda-row">
                  <td style="width:80px">
                    <% if (v.produto_imagem) { %>
                      <img src="<%= v.produto_imagem %>" alt="Foto" class="prod-thumb rounded">
                    <% } else { %>
                      <div class="prod-thumb placeholder rounded d-flex align-items-center justify-content-center text-muted">
                        <i class="fas fa-image"></i>
                      </div>
                    <% } %>
                  </td>
                  <!-- mostrar ID do PRODUTO -->
                  <td><strong><%= v.produto_id %></strong></td>
                  <!-- mostrar data/hora da venda (formatada pt-BR) -->
                  <td><strong><%= v.hora_venda ? (new Date(v.hora_venda)).toLocaleString('pt-BR') : '-' %></strong></td>
                  <td>
                    <strong class="produto-nome"><%= v.produto_nome %></strong>
                  </td>
                  <td>
                    <strong><%= v.cliente_nome %></strong>
                    <div class="small-muted"><%= v.cliente_email %></div>
                  </td>
                  <td class="text-center align-middle">
                    <div class="valor-mais">
                      <% 
                        const valorVenda = Number(v.valor_venda || 0);
                        const valorProduto = Number(v.produto_valor || 0);
                      %>
                      <% if (valorProduto && valorVenda < valorProduto) { %>
                        <div class="small-muted text-decoration-line-through">R$ <%= valorProduto.toLocaleString('pt-BR', {minimumFractionDigits:2}) %></div>
                        <div class="fw-bold">R$ <%= valorVenda.toLocaleString('pt-BR', {minimumFractionDigits:2}) %></div>
                      <% } else { %>
                        R$ <%= valorVenda.toLocaleString('pt-BR', {minimumFractionDigits:2}) %>
                      <% } %>
                    </div>
                  </td>
                  <td class="align-middle text-center">
                    <% if (v.produto_qtd_avaliacoes && v.produto_qtd_avaliacoes > 0) { %>
                      <div class="rating-stars">
                        <% 
                          var media = Number(v.produto_media) || 0;
                          var fullStars = Math.floor(media);
                          var hasHalfStar = media % 1 >= 0.3 && media % 1 <= 0.7;
                          var emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
                        %>
                        
                        <!-- Estrelas completas -->
                        <% for(var i=0; i < fullStars; i++) { %>
                          <i class="fas fa-star text-warning"></i>
                        <% } %>
                        
                        <!-- Meia estrela -->
                        <% if (hasHalfStar) { %>
                          <i class="fas fa-star-half-alt text-warning"></i>
                        <% } %>
                        
                        <!-- Estrelas vazias -->
                        <% for(var i=0; i < emptyStars; i++) { %>
                          <i class="fas fa-star"></i>
                        <% } %>
                      </div>
                      <div class="text-muted small mt-1"><%= v.produto_qtd_avaliacoes %> avaliação<%= v.produto_qtd_avaliacoes>1 ? 's' : '' %></div>
                    <% } else { %>
                      <span class="text-muted">-</span>
                    <% } %>
                  </td>
                  <td class="align-middle">
                    <div class="d-flex flex-column gap-2">
                      <!-- status badge -->
                      <div class="status-badge-container">
                        <% if (v.status === 'pendente') { %>
                          <span class="status-badge status-pendente">
                            <i class="fas fa-clock me-1"></i>Pendente
                          </span>
                        <% } else if (v.status === 'pronto') { %>
                          <span class="status-badge status-pronto">
                            <i class="fas fa-box me-1"></i>Pronto
                          </span>
                        <% } else if (v.status === 'a_caminho') { %>
                          <span class="status-badge status-caminho">
                            <i class="fas fa-shipping-fast me-1"></i>A caminho
                          </span>
                        <% } else if (v.status === 'entregue') { %>
                          <span class="status-badge status-entregue">
                            <i class="fas fa-check-circle me-1"></i>Entregue
                          </span>
                        <% } else if (v.status === 'realizada') { %>
                          <span class="status-badge status-entregue">
                            <i class="fas fa-check-circle me-1"></i>Realizada
                          </span>
                        <% } else { %>
                          <span class="status-badge status-desconhecido">
                            <i class="fas fa-question-circle me-1"></i><%= v.status || '—' %>
                          </span>
                        <% } %>
                      </div>

                      <!-- ações conforme status -->
                      <div class="action-buttons">
                        <% if (v.status === 'pendente') { %>
                          <button type="button" class="btn-action btn-action-ready action-post"
                                  data-endpoint="/adm/vendas/<%= v.ID %>/pronto"
                                  title="Marcar como pronto">
                            <i class="fas fa-box me-1"></i>Pronto para envio
                          </button>
                        <% } else if (v.status === 'pronto') { %>
                          <button type="button" class="btn-action btn-action-ship action-post"
                                  data-endpoint="/adm/vendas/<%= v.ID %>/caminho"
                                  title="Marcar como a caminho">
                            <i class="fas fa-shipping-fast me-1"></i>Enviar
                          </button>
                        <% } %>
                      </div>
                    </div>
                  </td>
                </tr>
              <% }) %>
            <% } else { %>
              <tr>
                <td colspan="8" class="text-center py-5">
                  <i class="fas fa-receipt fa-3x mb-3" style="color: #dee2e6;"></i>
                  <h5 class="text-muted">Nenhuma venda encontrada</h5>
                  <p class="text-muted mb-0">Tente ajustar os filtros para ver mais resultados.</p>
                </td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
document.addEventListener('click', function(event) {
  const btn = event.target.closest('.action-post');
  if (!btn) return;
  event.preventDefault();

  const raw = btn.dataset.endpoint || '';
  const m = raw.match(/\/vendas\/(\d+)\/(pronto|caminho|entregue)/);
  if (!m) {
    console.error('Endpoint inválido:', raw);
    return;
  }
  const id = m[1];
  const action = m[2];

  const pathParts = window.location.pathname.split('/').filter(Boolean);
  let base = '/adm/vendas';
  if (pathParts.length >= 2) base = '/' + pathParts[0] + '/' + pathParts[1];
  const endpoint = `${base}/${id}/${action}`;
  const altBase = base.startsWith('/admCenterMotos') ? base.replace('/admCenterMotos','/adm') : base.replace('/adm','/admCenterMotos');
  const altEndpoint = `${altBase}/${id}/${action}`;

  // Não trava o botão nem altera o texto permanentemente
  // Realiza a requisição e recarrega a página (mostra o resultado do servidor)
  (async () => {
    try {
      let resp = await fetch(endpoint, { method: 'POST', credentials: 'same-origin' });
      if (resp && resp.status === 404) {
        // tentar alternativa se 404
        await fetch(altEndpoint, { method: 'POST', credentials: 'same-origin' }).catch(e => console.error('fallback error', e));
      }
    } catch (err) {
      console.error('Erro na requisição:', err);
      // continua para recarregar mesmo em erro
    } finally {
      // aguarda um curto período para garantir que o servidor processe a mudança
      setTimeout(() => window.location.reload(), 500);
    }
  })();
});
</script>
</body>
</html>