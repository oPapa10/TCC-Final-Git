<!-- filepath: views/product.ejs -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Detalhes do Produto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/stylesheets/index.css"/>
    <link rel="stylesheet" href="/stylesheets/menu-superior.css"/>
    <link rel="stylesheet" href="/stylesheets/footer.css"/>
    <link rel="stylesheet" href="/stylesheets/product.css"/>
    <link rel="stylesheet" href="/stylesheets/theme.css">
    <link rel="stylesheet" href="/stylesheets/barra_rolagem.css">
</head>
<body>
    <%- include('partials/navbar', { usuario: usuario }) %>
    <!-- Conteúdo Principal -->
    <main class="container mt-5 pt-4">
        <% 
            // Calcula avaliações só uma vez para usar em todo o template
            var totalAvaliacoes = avaliacoes.length;
            var somaEstrelas = avaliacoes.reduce((soma, av) => soma + Number(av.estrela), 0);
            var media = totalAvaliacoes > 0 ? (somaEstrelas / totalAvaliacoes) : 0;
            var porcentagens = [5,4,3,2,1].map(function(estrela) {
                var qtd = avaliacoes.filter(function(av) { return Number(av.estrela) === estrela; }).length;
                return totalAvaliacoes > 0 ? Math.round((qtd / totalAvaliacoes) * 100) : 0;
            });
        %>
        <% if (produto) { %>
        <div class="row">
            <!-- Galeria de Imagens -->
            <div class="col-md-6">
                <div class="main-image mb-3">
                    <img id="mainProductImage" src="<%= produto.imagem %>" alt="Imagem do Produto" class="img-fluid rounded">
                </div>
                <div class="thumbnail-container d-flex">
                    <% if (produto.imagem) { %>
                        <img src="<%= produto.imagem %>" alt="Foto principal" class="img-thumbnail me-2" style="width: 60px; height: 60px;" onclick="showMainImage('<%= produto.imagem %>', this)">
                    <% } %>
                    <% if (produto.thumbnails) { 
                        let thumbs = Array.isArray(produto.thumbnails) ? produto.thumbnails : String(produto.thumbnails).split(',');
                        thumbs.forEach(function(url) {
                            url = url.trim();
                            if (url && url !== produto.imagem) { %>
                                <img src="<%= url %>" alt="Thumbnail" class="img-thumbnail me-2" style="width: 60px; height: 60px;" onclick="showMainImage('<%= url %>', this)">
                    <%      }
                        });
                    } %>
                </div>
            </div>
            
            <!-- Informações do Produto -->
            <div class="col-md-6">
                <h1 class="product-title"><%= produto.nome %></h1>
                <div class="rating mb-3">
                    <% 
                        var fullStars = Math.floor(media);
                        var hasHalfStar = media % 1 >= 0.3 && media % 1 <= 0.7;
                        var emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
                    %>
                    
                    <!-- Estrelas completas -->
                    <% for(var i=0; i < fullStars; i++) { %>
                        <span class="fa fa-star checked"></span>
                    <% } %>
                    
                    <!-- Meia estrela -->
                    <% if (hasHalfStar) { %>
                        <span class="fa fa-star-half-alt checked"></span>
                    <% } %>
                    
                    <!-- Estrelas vazias -->
                    <% for(var i=0; i < emptyStars; i++) { %>
                        <span class="fa fa-star"></span>
                    <% } %>
                    
                    <span class="ms-2"><%= media.toFixed(1) %> (<%= totalAvaliacoes %> avaliação<%= totalAvaliacoes === 1 ? '' : 's' %>)</span>
                </div>
                <div class="price-container mb-3">
                  <% if (produto.valor_promocional && Number(produto.valor_promocional) > 0) { %>
                    <span class="current-price text-danger fw-bold">
                      R$ <%= Number(produto.valor_promocional).toLocaleString('pt-BR', {minimumFractionDigits: 2}) %>
                    </span>
                    <span class="text-muted text-decoration-line-through ms-2">
                      R$ <%= Number(produto.valor).toLocaleString('pt-BR', {minimumFractionDigits: 2}) %>
                    </span>
                  <% } else { %>
                    <span class="current-price">
                      R$ <%= produto.valor ? Number(produto.valor).toLocaleString('pt-BR', {minimumFractionDigits: 2}) : '0,00' %>
                    </span>
                  <% } %>
                </div>
                <p class="product-description"><%= produto.descricao %></p>
                <div class="details-section product-details mb-4">
                    <h5 class="section-title">Detalhes do Produto</h5>
                    <ul class="details-list">
                        <% if (produto.cor) { %><li><strong>Cor:</strong> <%= produto.cor %></li><% } %>
                        <% if (produto.tamanho) { %><li><strong>Tamanho:</strong> <%= produto.tamanho %></li><% } %>
                        <% if (produto.peso) { %><li><strong>Peso:</strong> <%= produto.peso %> kg</li><% } %>
                        <% if (produto.cilindrada) { %><li><strong>Cilindrada:</strong> <%= produto.cilindrada %></li><% } %>
                        <% if (produto.potencia) { %><li><strong>Potência:</strong> <%= produto.potencia %></li><% } %>
                        <% if (produto.tanque) { %><li><strong>Tanque:</strong> <%= produto.tanque %></li><% } %>
                        <% if (produto.estoque) { %><li><strong>Estoque:</strong> <%= produto.estoque %></li><% } %>
                        <% if (produto.material) { %><li><strong>Material:</strong> <%= produto.material %></li><% } %>
                        <% if (produto.protecao) { %><li><strong>Proteção:</strong> <%= produto.protecao %></li><% } %>
                    </ul>
                </div>
                <form id="addToCartForm" action="/carrinho/adicionar" method="POST" class="mb-3">
                    <input type="hidden" name="produtoId" value="<%= produto.ID %>">
                    <div class="d-flex align-items-center mb-3" style="max-width: 350px;">
                        <div class="input-group" style="max-width: 200px;">
                            <span class="input-group-text">Qtd</span>
                            <input 
                                type="number" 
                                name="quantidade" 
                                class="form-control" 
                                value="1" 
                                min="1" 
                                max="<%= produto.estoque || 1 %>" 
                                required
                            >
                        </div>
                        <small class="text-muted ms-3">
                            Estoque disponível: <%= produto.estoque %> unidade<%= produto.estoque == 1 ? '' : 's' %>
                        </small>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-cart-plus"></i> Adicionar ao Carrinho
                    </button>
                </form>
                <div id="cartMessage" class="cart-message">Produto adicionado ao carrinho!</div>
                <script>
                document.getElementById('addToCartForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    const form = this;
                    const data = new URLSearchParams(new FormData(form));
                    fetch(form.action, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: data
                    })
                    .then(res => res.json())
                    .then(json => {
                        if (json.success) {
                            const msg = document.getElementById('cartMessage');
                            msg.style.display = 'block';
                            setTimeout(() => { msg.style.display = 'none'; }, 2000);
                        } else {
                            alert(json.message || 'Erro ao adicionar ao carrinho');
                        }
                    });
                });
                </script>

                <!-- ÁREA DE COMPRA AGORA COM CONFIRMAÇÃO -->
                <div class="buy-now-section">
                    <!-- Botão que abre o modal / exige login -->
                    <% if (usuario) { %>
                      <a href="/pagamento?valor=<%= produto.valor_promocional && Number(produto.valor_promocional) > 0 ? produto.valor_promocional : produto.valor %>&descricao=Compra+de+<%= encodeURIComponent(produto.nome) %>&produtoId=<%= produto.ID %>"
                         class="btn btn-primary btn-buy-now">
                        <i class="fas fa-bolt me-2"></i>Comprar Agora
                      </a>
                    <% } else { %>
                      <a href="/perfil"
                         class="btn btn-outline-primary btn-buy-now" title="Faça login para finalizar a compra">
                        <i class="fas fa-sign-in-alt me-2"></i>Fazer login para finalizar compra
                      </a>
                    <% } %>
                </div>

                <% if (typeof mensagemNaoLogado !== 'undefined' && mensagemNaoLogado) { %>
                    <div class="alert alert-warning text-center mt-3">
                        <%= mensagemNaoLogado %>
                    </div>
                <% } %>
                <script>
                document.getElementById('formComprarAgora').addEventListener('submit', function(e) {
                    var qtd = document.querySelector('input[name="quantidade"]').value;
                    document.getElementById('quantidadeComprarAgora').value = qtd;
                });
                </script>
            </div>
        </div>

        <!-- Avaliações e Comentários -->
        <section class="reviews-section mt-5">
            <h3 class="section-title mb-4">Avaliações dos Clientes</h3>
            <!-- Resumo das avaliações -->
            <div class="review-summary mb-4">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <div class="average-rating"><%= media.toFixed(1) %></div>
                        <div class="stars mb-2">
                            <% 
                                var fullStars = Math.floor(media);
                                var hasHalfStar = media % 1 >= 0.3 && media % 1 <= 0.7;
                                var emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
                            %>
                            
                            <!-- Estrelas completas -->
                            <% for(var i=0; i < fullStars; i++) { %>
                                <span class="fa fa-star checked"></span>
                            <% } %>
                            
                            <!-- Meia estrela -->
                            <% if (hasHalfStar) { %>
                                <span class="fa fa-star-half-alt checked"></span>
                            <% } %>
                            
                            <!-- Estrelas vazias -->
                            <% for(var i=0; i < emptyStars; i++) { %>
                                <span class="fa fa-star"></span>
                            <% } %>
                        </div>
                        <div class="total-reviews"><%= totalAvaliacoes %> avaliação<%= totalAvaliacoes === 1 ? '' : 's' %></div>
                    </div>
                    <div class="col-md-9">
                        <div class="rating-progress">
                            <% [5,4,3,2,1].forEach(function(estrela, idx) { %>
                                <div class="progress-item">
                                    <span><%= estrela %> estrela<%= estrela === 1 ? '' : 's' %></span>
                                    <div class="progress">
                                        <div class="progress-bar" style="width: <%= porcentagens[idx] %>%"></div>
                                    </div>
                                    <span><%= porcentagens[idx] %>%</span>
                                </div>
                            <% }) %>
                        </div>
                    </div>
                </div>
            </div>
            <div class="user-reviews">
                <% avaliacoes.forEach(function(av) { 
                    var isMinhaAvaliacao = usuario && av.usuario_id && usuario.ID == av.usuario_id;
                %>
                    <div class="review-card">
                        <div class="review-header">
                            <div class="user-info">
                                <% if (isMinhaAvaliacao) { %>
                                    <span class="user-name text-primary"><i class="fas fa-user-check me-1"></i>Sua avaliação</span>
                                <% } else { %>
                                    <span class="user-name"><%= av.usuario_nome || 'Visitante' %></span>
                                <% } %>
                                <div class="rating">
                                    <% for(var i=1; i<=5; i++) { %>
                                        <span class="fa fa-star <%= i <= av.estrela ? 'checked' : '' %>"></span>
                                    <% } %>
                                </div>
                            </div>
                            <span class="review-date"><%= new Date(av.data_avaliacao).toLocaleDateString() %></span>
                        </div>
                        <h5 class="review-title"><%= av.titulo %></h5>
                        <p class="review-text"><%= av.descricao %></p>
                    </div>
                <% }) %>
            </div>
            <button class="btn btn-outline-primary mt-3">Ver todas as avaliações</button>
        </section>

        <!-- Produtos Relacionados -->
        <section class="related-products mt-5">
            <h3 class="section-title mb-4">Produtos Relacionados</h3>
            <div class="row">
                <% if (relacionados && relacionados.length > 0) { %>
                    <% relacionados.forEach(function(rel) { %>
                        <div class="col-6 col-md-3 mb-4">
                            <div class="card product-card">
                                <img src="<%= rel.imagem %>" class="card-img-top" alt="Produto Relacionado">
                                <div class="card-body">
                                    <h5 class="card-title"><%= rel.nome %></h5>
                                    <p class="card-text"><%= rel.descricao %></p>
                                    <p class="price">R$ <%= Number(rel.valor).toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></p>
                                    <a href="/p/<%= rel.slug %>" class="stretched-link product-link"></a>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                <% } else { %>
                    <div class="col-12">
                        <p class="text-muted">Nenhum produto relacionado encontrado.</p>
                    </div>
                <% } %>
            </div>
        </section>
        <% } else { %>
            <div class="alert alert-danger mt-5">Produto não encontrado.</div>
        <% } %>
    </main>
    <%- include('partials/footer') %>
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/javascripts/product.js"></script>
    <script src="/javascripts/index.js"></script>
    <script>
    function showMainImage(url, thumb) {
        document.getElementById('mainProductImage').src = url;
    }

    // Limita o campo de quantidade ao estoque disponível SOMENTE se ultrapassar o máximo
    document.addEventListener('DOMContentLoaded', function() {
        const qtdInput = document.querySelector('input[name="quantidade"]');
        const estoqueMax = Number(qtdInput?.max) || 1;
        qtdInput?.addEventListener('input', function() {
            if (Number(this.value) > estoqueMax) {
                this.value = estoqueMax;
            }
        });
    });

    (function() {
      var theme = localStorage.getItem('theme');
      if (theme === 'escuro') {
        document.body.classList.add('dark-theme');
      } else {
        document.body.classList.remove('dark-theme');
      }
    })();
    </script>
</body>
</html>