<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Editar Perfil</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/stylesheets/menu-superior.css">
  <link rel="stylesheet" href="/stylesheets/editar-perfil.css">
  <link rel="stylesheet" href="/stylesheets/theme.css">
  <link rel="stylesheet" href="/stylesheets/footer.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <%- include('partials/navbar', { usuario: usuario }) %>

  <main class="container mt-5 pt-5">
    <div class="row">
      <div class="col-lg-4 mb-4">
        <div class="card profile-card shadow-lg">
          <div class="card-body text-center">
            <div class="avatar mb-3">
              <% if (usuario && usuario.avatar) { %>
                <img src="<%= usuario.avatar %>" alt="avatar" class="rounded-circle">
              <% } else { %>
                <i class="fas fa-user-circle default-avatar"></i>
              <% } %>
            </div>
            <h5 class="mb-0"><%= usuario ? usuario.nome : '' %></h5>
            <p class="text-muted small mb-2"><i class="fas fa-envelope me-1"></i> <%= usuario ? usuario.email : '' %></p>
            <a href="/perfil" class="btn btn-outline-secondary btn-sm mt-2">
              <i class="fas fa-arrow-left me-1"></i> Voltar ao Perfil
            </a>
          </div>
        </div>
      </div>

      <div class="col-lg-8">
        <% if (status && msg) { %>
          <div class="alert alert-<%= status === 'success' ? 'success' : 'danger' %> alert-dismissible fade show" role="alert">
            <i class="fas <%= status === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle' %> me-2"></i>
            <%= msg %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        <% } %>

        <div class="card shadow-lg">
          <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-user-edit me-2"></i> Editar Perfil</h4>
          </div>
          <div class="card-body p-4">
            <div class="accordion" id="editAccordion">
              <!-- Perfil -->
              <div class="accordion-item border-0 mb-3">
                <h2 class="accordion-header" id="headingProfile">
                  <button class="accordion-button rounded" type="button" data-bs-toggle="collapse" data-bs-target="#profile-section" aria-expanded="true">
                    <i class="fas fa-user me-2"></i> Informações pessoais
                  </button>
                </h2>
                <div id="profile-section" class="accordion-collapse collapse show" data-bs-parent="#editAccordion">
                  <div class="accordion-body pt-3">
                    <form action="/editar-perfil" method="POST" class="row g-3">
                      <input type="hidden" name="section" value="profile">
                      <div class="col-md-12">
                        <label class="form-label fw-semibold">Nome completo</label>
                        <input name="nome" class="form-control form-control-lg" required value="<%= usuario ? usuario.nome : '' %>">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Email</label>
                        <input name="email" type="email" class="form-control form-control-lg" required value="<%= usuario ? usuario.email : '' %>">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Telefone</label>
                        <input name="telefone" class="form-control form-control-lg" value="<%= usuario ? usuario.telefone : '' %>">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Gênero</label>
                        <select name="genero" class="form-select form-select-lg">
                          <option value="">Prefiro não informar</option>
                          <option value="Masculino" <%= usuario && usuario.genero==='Masculino' ? 'selected' : '' %>>Masculino</option>
                          <option value="Feminino" <%= usuario && usuario.genero==='Feminino' ? 'selected' : '' %>>Feminino</option>
                          <option value="Outro" <%= usuario && usuario.genero==='Outro' ? 'selected' : '' %>>Outro</option>
                        </select>
                      </div>
                      <div class="col-12 d-flex justify-content-end mt-4">
                        <button class="btn btn-primary btn-lg px-4">
                          <i class="fas fa-save me-2"></i> Salvar informações
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <!-- Segurança / senha -->
              <div class="accordion-item border-0 mb-3">
                <h2 class="accordion-header" id="headingSecurity">
                  <button class="accordion-button collapsed rounded" type="button" data-bs-toggle="collapse" data-bs-target="#security-section">
                    <i class="fas fa-lock me-2"></i> Segurança
                  </button>
                </h2>
                <div id="security-section" class="accordion-collapse collapse" data-bs-parent="#editAccordion">
                  <div class="accordion-body pt-3">
                    <form action="/editar-perfil" method="POST" class="row g-3" onsubmit="return validatePasswordForm(this);">
                      <input type="hidden" name="section" value="password">
                      <div class="col-md-12">
                        <label class="form-label fw-semibold">Senha atual</label>
                        <input name="currentPassword" type="password" class="form-control form-control-lg" required>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Nova senha</label>
                        <input name="newPassword" id="newPassword" type="password" class="form-control form-control-lg" required>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Confirmar nova senha</label>
                        <input name="newPasswordConfirm" id="newPasswordConfirm" type="password" class="form-control form-control-lg" required>
                      </div>
                      <div class="col-12 d-flex justify-content-end mt-4">
                        <button class="btn btn-primary btn-lg px-4">
                          <i class="fas fa-key me-2"></i> Alterar senha
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <!-- Endereço -->
              <div class="accordion-item border-0">
                <h2 class="accordion-header" id="headingAddress">
                  <button class="accordion-button collapsed rounded" type="button" data-bs-toggle="collapse" data-bs-target="#address-section">
                    <i class="fas fa-home me-2"></i> Endereço
                  </button>
                </h2>
                <div id="address-section" class="accordion-collapse collapse" data-bs-parent="#editAccordion">
                  <div class="accordion-body pt-3">
                    <form action="/editar-perfil" method="POST" class="row g-3">
                      <input type="hidden" name="section" value="address">
                      <div class="col-md-4">
                        <label class="form-label fw-semibold">Estado (UF)</label>
                        <input name="estado" class="form-control form-control-lg" value="<%= usuario ? usuario.estado : '' %>">
                      </div>
                      <div class="col-md-8">
                        <label class="form-label fw-semibold">Cidade</label>
                        <input name="cidade" class="form-control form-control-lg" value="<%= usuario ? usuario.cidade : '' %>">
                      </div>
                      <div class="col-md-8">
                        <label class="form-label fw-semibold">Bairro</label>
                        <input name="rua" class="form-control form-control-lg" value="<%= usuario ? usuario.rua : '' %>" required>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label fw-semibold">Número</label>
                        <input name="numero" class="form-control form-control-lg" value="<%= usuario ? usuario.numero : '' %>">
                      </div>
                      <div class="col-12">
                        <label class="form-label fw-semibold">Complemento</label>
                        <input name="complemento" class="form-control form-control-lg" value="<%= usuario ? usuario.complemento : '' %>">
                      </div>
                      <div class="col-12 d-flex justify-content-end mt-4">
                        <button class="btn btn-primary btn-lg px-4">
                          <i class="fas fa-map-marker-alt me-2"></i> Salvar endereço
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

            </div> <!-- accordion -->
          </div>
        </div>

      </div>
    </div>
  </main>

  <%- include('partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function validatePasswordForm(form) {
      const a = form.newPassword.value.trim();
      const b = form.newPasswordConfirm.value.trim();
      if (a.length < 6) {
        alert('A nova senha deve ter ao menos 6 caracteres.');
        return false;
      }
      if (a !== b) {
        alert('Confirmação de senha não corresponde.');
        return false;
      }
      return true;
    }
    // atalhos para abrir seção via links
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.options-sidebar .nav-link, .link-primary').forEach(el => {
        el.addEventListener('click', (e) => {
          const href = el.getAttribute('href');
          if (href && href.startsWith('#')) {
            e.preventDefault();
            const target = document.querySelector(href);
            if (target) {
              const bsCollapse = new bootstrap.Collapse(target, { toggle: true });
              target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }
        });
      });
    });
  </script>
</body>
</html>